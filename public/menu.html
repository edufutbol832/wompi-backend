<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menú Principal con Pago Wompi</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .modulo { display: none; }
    .visible { display: block; }
    button { padding: 10px 20px; margin: 10px 0; font-size: 1rem; cursor: pointer; }
  </style>
</head>
<body>

  <h1>📋 Menú Principal</h1>

  <div id="menuPrincipal" class="visible">
    <button onclick="mostrarModulo('Pago')">💳 Pago</button>
    <!-- Aquí puedes agregar más botones para otros módulos -->
  </div>

  <div id="moduloPago" class="modulo">
    <h2>💳 Módulo de Pago Wompi (Sandbox)</h2>
    <div id="wompi-container">
      <p>Generando referencia y firma...</p>
    </div>
    <button onclick="volverAlMenu()">🔙 Retornar al Menú</button>
  </div>

  <!-- Script oficial Wompi para renderizar botones -->
  <script src="https://checkout.wompi.co/widget.js"></script>

  <script>
    // Mostrar módulo y ocultar menú
    function mostrarModulo(nombre) {
      document.getElementById('menuPrincipal').classList.remove('visible');
      document.getElementById('menuPrincipal').classList.add('modulo');
      if (nombre === 'Pago') {
        document.getElementById('moduloPago').classList.add('visible');
        document.getElementById('moduloPago').classList.remove('modulo');
        cargarBotonWompi();
      }
    }

    // Volver al menú principal
    function volverAlMenu() {
      document.getElementById('moduloPago').classList.remove('visible');
      document.getElementById('moduloPago').classList.add('modulo');

      document.getElementById('menuPrincipal').classList.add('visible');
      document.getElementById('menuPrincipal').classList.remove('modulo');

      // Resetear contenedor para próximo pago
      document.getElementById('wompi-container').innerHTML = '<p>Generando referencia y firma...</p>';
    }

    // Función para pedir la firma a tu backend y crear botón Wompi
    async function cargarBotonWompi() {
      const amountInCents = 150000; // Valor en centavos (1500 COP)
      const currency = "COP";
      const reference = "edupago-" + Date.now();

      try {
        // Llamada POST a tu backend para obtener firma
        const respuesta = await fetch("https://wompi-backend-nuevo.onrender.com/generate-signature", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount_in_cents: amountInCents, currency, reference })
        });

        const data = await respuesta.json();

        if (!respuesta.ok) {
          throw new Error(data.error || "Error al obtener firma");
        }

        // Crear botón Wompi con atributos requeridos
        const contenedor = document.getElementById("wompi-container");
        contenedor.innerHTML = "";

        const botonWompi = document.createElement("div");
        botonWompi.id = "wompi-button";
        botonWompi.setAttribute("data-render", "button");
        botonWompi.setAttribute("data-public-key", "pub_test_K9UBxtRMrdrjaNBNdpuqoLYxmh8feExG");
        botonWompi.setAttribute("data-currency", currency);
        botonWompi.setAttribute("data-amount-in-cents", amountInCents.toString());
        botonWompi.setAttribute("data-reference", reference);
        botonWompi.setAttribute("data-signature-integrity", data.signature);
        botonWompi.setAttribute("data-redirect-url", "https://wompi-backend-nuevo.onrender.com/redirect");

        contenedor.appendChild(botonWompi);

        // Renderizar botón Wompi
        if (window.$wompi && window.$wompi.render) {
          window.$wompi.render();
        }

      } catch (error) {
        console.error(error);
        document.getElementById('wompi-container').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    }
  </script>

</body>
</html>
